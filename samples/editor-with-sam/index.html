<!doctype html>
<html>

<head>
    <link rel="stylesheet" href="css/index.css" />
    <title>CanvasTools Samples - Images Editor</title>
</head>

<body>
    <h1>CanvasTools Samples - Images Editor</h1>
    <div id="canvasToolsDiv">
        <div id="toolbarDiv">
        </div>
        <div id="selectionDiv" onmousewheel="onWheelCapture(event)">
            <div id="editorDiv"></div>
        </div>
    </div>
    <div id="tagsDiv"></div>
    <div id="controls">
        <div>
            <label for="imageSelect" >Choose image: </label>
            <select id="imageSelect">
            </select>
        </div>
        <div>
            <label for="tagColorSelect" >Choose label: </label>
            <select id="tagColorSelect">
                <option value="#c48de7">Awesome</option>
                <option value="#3b1fff">Amazing</option>
                <option value="#f94c48">Brilliant</option>
            </select>
        </div>
        <div>
            <label for="brushModeSelect" >Choose brush type: </label>
            <select id="brushModeSelect">
                <option value="NONE">None</option>
                <option value="6">Brush</option>
                <option value="7">Eraser</option>
            </select>
        </div>
        <div>
            <label for="brushSizeSelect" >Choose brush/eraser size: </label>
            <select id="brushSizeSelect">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
            </select>
        </div>
        <div>
            <button id="getRegion">Get Region !</button>
            <button id="disableAS">Disable AS</button>
            <button id="enableAS">Enable AS</button>
            <button id="getAllMasks">Get all masks</button>
            <button id="loadAllMasks">Load all masks</button>
            <button id="convert">Convert</button>
            <button id="toggleVisibility">Toggle visibility</button>
            <button id="eraseAllMasks">Erase</button>
            <button id="startSAM">Start SAM</button>
        </div>
        <div id="showZoomFactor"></div>
        <input id="resetZoomOnLoad" type="checkbox"></input>
        <label id="resetZoomOnLoadLabel">Reset Zoom On Content Load</label>
    </div>
</body>
<script src="./../shared/js/ct.js"></script>
<script>
    // The list of images
    const images = [
            {
                path: "./../shared/media/dogs.jpg",
                title: "Dogs",
                embeddings: "./../shared/segment_anything/dogs_embedding.npy"
            },
            {
                path: "./../shared/media/background-shapesTest.jpg",
                title: "Shapes (1)"
            },
            {
                path: "./../shared/media/background-shapesTest.jpg",
                title: "Shapes (2)"
            },
            {
                path: "./../shared/media/background-cat-hd.jpg",
                title: "Cat (HD)"
            },
            {
                path: "./../shared/media/background-cat2.jpg",
                title: "Cat - Grumpy"
            },
            {
                path: "./../shared/media/background-cat3.jpg",
                title: "Cat - Inspiring"
            },                                   
            {
                path: "./../shared/media/background-city.jpg",
                title: "City"
            },
            {
                path: "./../shared/media/background-forest-hd.jpg",
                title: "Forest (HD)"
            },
            {
                path: "./../shared/media/background-glass.jpg",
                title: "Cafe"
            },
            {
                path: "./../shared/media/background-sea-hd.jpg",
                title: "Sea (HD)"
            },
            {
                path: "./../shared/media/background-snow.jpg",
                title: "Snow"
            }, 
        ];

    const tagNames = ["Awesome", "Amazing", "Brilliante", "Incredible", "Marvelous",
                "Unbelievable", "Wonderful", "Shocking", "Surprising", "Startling"];
    
    // will be populated on load
    var tags = [];
    
    // Current active tag
    var activeTag;

    var editor;
    
    var maskSize = 20;

    document.addEventListener("DOMContentLoaded", (e) => {
        // Get references for editor and toolbar containers
        const editorContainer = document.getElementById("editorDiv");
        const toolbarContainer = document.getElementById("toolbarDiv");

        // Init the editor with toolbar.
        editor = new CanvasTools.Editor(editorContainer, undefined, undefined, undefined, {
            isZoomEnabled: true,
            zoomType: 3
        }, true).api;

        editor.MM.loadOnnxModel("./../shared/segment_anything/sam_onnx_quantized_example.onnx").then(() => {
            console.log("onnx model ready");
        });
        editor.addToolbar(toolbarContainer, CanvasTools.Editor.FullToolbarSet, "./../shared/media/icons/");
        editor.enablePathRegions(true);

        // Define palette settings
        const paletteSettings = {
            lightness: 0.6,
            lightnessVariation: 0.1,
            minGrayness: 0.2,
            maxGrayness: 0.6,
            granularity: 100,
            abRange: 1.3,
        };

        // Create new pallete
        const palette = new CanvasTools.Core.Colors.Palette(paletteSettings);

        // Define the number of swatches
        const swatchesCount = tagNames.length;

        // Request swatches from the pallete
        palette.swatches(swatchesCount).then((gamut) => {
            // Create collection of tags using names and generated colors
            tags = gamut.map((color, index) => {
                return new CanvasTools.Core.Tag(tagNames[index], color);
            });

            // Populate tags buttons to the UI
            const tagsContainer = document.getElementById("tagsDiv");
            populateTags(tagsContainer, tags);
        });

        let incrementalRegionID = 100;

        // Add new region to the editor when new region is created
        editor.onSelectionEnd = (regionData) => {
            let tag = getTagsDescriptor();
            if (this.samStarted) {
                editor.MM.runOnnx({ x: regionData.x, y: regionData.y }, tag);
                this.samStarted = false;
                return;
            }
            let id = (incrementalRegionID++).toString();

            editor.addRegion(id, regionData, tag);

            console.log(`Created ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };     

        // Log region manipulations
        editor.onRegionMoveBegin = (id, regionData) => {
            console.log(`Began moving ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };
        editor.onRegionMove = (id, regionData) => {
            //
        };
        editor.onRegionMoveEnd = (id, regionData) => {
            console.log(`Ended moving ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };
        editor.onRegionSelected = (id, multiSelection) => {
            console.log(`Selected ${id}: multiSelection = ${multiSelection}`);
        }
        editor.onRegionDelete = (id, regionData) => {
            console.log(`Deleted ${id}: {${regionData.x}, ${regionData.y}} x {${regionData.width}, ${regionData.height}}`);
        };

        editor.onMaskDrawingBegin = () => {
            return getTagsDescriptor();
        };

        editor.onMaskDrawingEnd = (drawnMask) => {
        };

        editor.onMaskGenerationBegin = () => {
            console.log((new Date()).getMilliseconds());
        };

        editor.onMaskGenerationEnd = () => {
            console.log((new Date()).getMilliseconds());
        };

        editor.ZM.setMaxZoomScale(10);
        editor.ZM.resetZoomOnContentLoad = true;

        let imageIndex = 0;
        // Init images selector
        initImageSelect(images, (index, imageMeta) => {
            if (index == 1) {
                editorContainer.classList.add("changeSize");
            } else {
                editorContainer.classList.remove("changeSize");
            }
            imageIndex = index;
            loadImage(imageMeta, (image) => {
                editor.addContentSource(image);
                editor.AS.setSelectionMode(2);

                var showZoomDiv = document.getElementById("showZoomFactor");
                showZoomDiv.innerText = "Image zoomed at " + editor.ZM.getZoomData().currentZoomScale*100 + " %";
            });

            // Delete current regions on image change
            editor.deleteAllRegions();
        });

        // Load first image
        loadImage(images[imageIndex], (image) => {
            editor.addContentSource(image);
        });

        initBrushModeSelect((value) => {
            editor.AS.setSelectionMode(parseInt(value));
        });

        initBrushSizeSelect((value) => {
            editor.MM.setBrushSize({brush: parseInt(value), erase: parseInt(value)});
        });

        var getRegionButton = document.getElementById("getRegion");
        getRegionButton.addEventListener("click", (e) => {
            var x = editor.RM.getAllRegions()[0].regionData;
            console.log(x);
        });

        var getRegionButton = document.getElementById("disableAS");
        getRegionButton.addEventListener("click", (e) => {
            editor.AS.hide();
        });

        var getRegionButton = document.getElementById("enableAS");
        getRegionButton.addEventListener("click", (e) => {
            editor.AS.show();
        });

        var getAllMasksButton = document.getElementById("getAllMasks");
        getAllMasksButton.addEventListener("click", (e) => {
            var a = editor.MM.getAllMasks();
            window["brushData"] = a;
        });

        var eraseAllMasksButton = document.getElementById("eraseAllMasks");
        eraseAllMasksButton.addEventListener("click", (e) => {
            editor.MM.eraseAllMasks();
        });

        this.samStarted = true;
        var startSAMButton = document.getElementById("startSAM");
        startSAMButton.addEventListener("click", (e) => {
            this.samStarted = true;
        });

        var loadAllMasksButton = document.getElementById("loadAllMasks");
        loadAllMasksButton.addEventListener("click", (e) => {
            editor.MM.eraseAllMasks();
            editor.MM.loadAllMasks(window["brushData"]);
        });
        var convertButton = document.getElementById("convert");
        convertButton.addEventListener("click", (e) => {
            editor.MM.polygonsToMask();
        });

        var toggleVisibility = true;
        var toggleVisibilityButton = document.getElementById("toggleVisibility");
        toggleVisibilityButton.addEventListener("click", (e) => {
            // var tagName = "Awesome";
            var tag = getActiveTag();
            Object.keys(colorObject).forEach(function (o) {
                if (o == tag) {
                    tagName = colorObject[o];
                }
            });
            editor.MM.updateMaskVisibility(!toggleVisibility, tagName);
            toggleVisibility = !toggleVisibility;
        });

        var showZoomDiv = document.getElementById("showZoomFactor");
        editor.onZoomEnd = function (zoom) {
            showZoomDiv.innerText = "Image zoomed at " + zoom.currentZoomScale*100 + " %";
            console.log(zoom.maxZoomScale);
        }

        // check if reset zoom is On.
        var resetZoomInput = document.getElementById("resetZoomOnLoad");
        if (resetZoomOnLoad.checked) {
            editor.ZM.resetZoomOnContentLoad = true;
        }
        resetZoomInput.addEventListener("click", (e) => {
            if (resetZoomOnLoad.checked) {
                editor.ZM.resetZoomOnContentLoad = true;
            } else {
                editor.ZM.resetZoomOnContentLoad = false;
            }
        });
    });

    // Add buttons for the tags to the container element
    function populateTags(container, tags) {
        tags.forEach((tag) => {
            // Create a button
            const tagButton = document.createElement("button");
            tagButton.classList.add("tagButton");

            // Use tag properties to "style" the button
            tagButton.innerHTML = tag.name;
            tagButton.style.backgroundColor = tag.color;
            
            // Add listener for button click
            tagButton.addEventListener("click", (e) => {
                // Clear active tags
                container.querySelectorAll("button").forEach((button) => button.classList.remove("active"));
                // Make this tag active
                tagButton.classList.add("active");
                activeTag = tag;
            });

            // Append button to the container
            container.append(tagButton);
        });

        // set the first tag active
        container.querySelector("button").classList.add("active");
        activeTag = tags[0];
    }

    // Randomly generate tags descriptor object
    function getTagsDescriptor() {
        return new CanvasTools.Core.TagsDescriptor([activeTag]);
    };

    // Builds select element using provided list of images 
    function initImageSelect(images, onSelect) {
        var imageSelect = document.getElementById("imageSelect");

        images.forEach((image) => {
            let o = document.createElement("option");
            o.text = image.title;
            imageSelect.add(o);
        })
        imageSelect.selectedIndex = 0;

        // Register listener for image change
        imageSelect.addEventListener("change", (e) => {
            let index = imageSelect.selectedIndex;
            if (index >= 0 && index < images.length) {
                onSelect(index, images[index]);
            }
        });
    }

    function initBrushModeSelect(onSelect) {
        var brushModeSelect = document.getElementById("brushModeSelect");
        brushModeSelect.selectedIndex = 0;

        brushModeSelect.addEventListener("change", (e) => {
            onSelect(e.target.value);
        });
    }

    function initBrushSizeSelect(onSelect) {
        var brushSizeSelect = document.getElementById("brushSizeSelect");
        brushSizeSelect.selectedIndex = 3;
        brushSizeSelect.addEventListener("change", (e) => {
            onSelect(e.target.value);
        });
    }

    function initTagColorSelect(onSelect) {
        var tagColorSelect = document.getElementById("tagColorSelect");
        tagColorSelect.selectedIndex = 0;
        tagColorSelect.addEventListener("change", (e) => {
            onSelect(e.target.value);
        });
    }

    // Load an image from specified path and notify when it is loaded.
    function loadImage(imageMeta, onReady) {
        const image = new Image();
        let target;
        let onReadyResolve;
        const onReadyPromise = new Promise((innerResolve) => {
            onReadyResolve = innerResolve;
        });
        let embeddingsResolve;
        const embeddingsPromise = new Promise((innerResolve) => {
            embeddingsResolve = innerResolve;
        });

        image.addEventListener("load", (e) => {
            target = e.target;
            onReadyResolve();
        });
        if (editor && imageMeta.embeddings) {
            editor.MM.loadSourceEmbeddings(imageMeta.embeddings).then(embeddingsResolve);
        } else {
            embeddingsResolve();
        }
        image.src = imageMeta.path;
        Promise.all([onReadyPromise, embeddingsPromise]).then(() => {
            onReady(target);
        });
    }

    function onWheelCapture(e) {
        if (!e.ctrlKey && !e.shiftKey && e.altKey && editor) {
            const cursorPos = getCursorPos(e);
            if (e.deltaY < 0) {
                editor.ZM.callbacks.onZoomingIn(cursorPos);
            } else if (e.deltaY > 0) {
                editor.ZM.callbacks.onZoomingOut(cursorPos);
            }
            e.stopImmediatePropagation();
            e.stopPropagation();
            e.preventDefault();
        }
    }

    function getCursorPos(e) {
        const editorContainer = document.getElementsByClassName("CanvasToolsEditor")[0];
        var containerPos, x = 0, y = 0;
        e = e || window.event;
        /*get the x and y positions of the container:*/
        containerPos = editorContainer.getBoundingClientRect();

        /*get the x and y positions of the image:*/
        var editorStyles = window.getComputedStyle(editorContainer);
        var imagePos = {
            left: containerPos.left + parseFloat(editorStyles.paddingLeft),
            top: containerPos.top + parseFloat(editorStyles.paddingTop)
        };


        /*calculate the cursor's x and y coordinates, relative to the image:*/
        x = e.pageX - imagePos.left;
        y = e.pageY - imagePos.top;
        /*consider any page scrolling:*/
        x = x - window.pageXOffset;
        y = y - window.pageYOffset;
        return {x : x, y : y};
    }
</script>

</html>